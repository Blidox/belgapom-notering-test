<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
<link rel="icon" type="image/svg+xml" href="assets/Asset%201.svg">

  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belgapom – Notering / Cotation / Quotation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root{
      /* Primair accent */
      --brand-primary:#FFCA00; /* geel */
      /* Neutraal i.p.v. navy */
      --brand-neutral:#3f3f3f; /* donkergrijs */
      --accent-quote:#2aa36b;  /* groen voor notering-lijn (leesbaar op wit) */
      /* UI */
      --bg:#f7f7f8; --ink:#111827; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb;
    }
    /* Forceer lichte UI (geen donker thema) */
    html,body{ background:var(--bg); color:var(--ink); }
    .brand-grad{ background:linear-gradient(135deg,var(--brand-primary), #ffe480 70%); }
    .btn{ padding:.55rem .8rem; border-radius:0.75rem; border:1px solid var(--line); background:var(--card); font-size:.95rem }
    .btn-active{ background:var(--brand-primary); color:#1a1a1a; border-color:transparent; font-weight:700; }
    .chip{ display:inline-block; padding:.25rem .75rem; border-radius:999px; font-size:.78rem; font-weight:700 }
    .chip-green{ background:var(--accent-quote); color:white; }
    .chip-slate{ background:#475569; color:white; }
    .chip-red{ background:#b91c1c; color:white; }
    .kpi{ font-size:clamp(1.15rem, 2.6vw, 1.5rem); font-weight:800 }
    @media print { .no-print { display:none !important } }
    .spinner{ width:22px;height:22px;border:3px solid rgba(0,0,0,.15);border-top-color:rgba(0,0,0,.6);border-radius:50%;animation:spin .9s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.85);backdrop-filter:blur(2px)}
    .loading-hidden{display:none!important}
    .notice{background:#fff7d6;border:1px solid #f2e4a3;color:#5b4a00;padding:.5rem .75rem;border-radius:.75rem;font-size:.9rem}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="sticky top-0 z-20 border-b bg-white/90 backdrop-blur" style="border-color:var(--line)">
    <div class="max-w-6xl mx-auto px-3 md:px-4 py-2 md:py-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="assets/belgapom-logo.svg" alt="Belgapom" class="h-8 w-auto"/>
        <div>
          <h1 id="title" class="font-semibold text-base md:text-lg">Belgapom – Notering</h1>
          <p id="subtitle" class="text-xs md:text-sm" style="color:var(--muted)">Contractprijzen en wekelijkse notering (vrije aardappelen)</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-1 md:gap-2 no-print mt-2 sm:mt-0">
        <button id="btn-nl" class="btn">NL</button>
        <button id="btn-fr" class="btn">FR</button>
        <button id="btn-en" class="btn">EN</button>
        <button id="btn-print" class="btn hidden md:inline-flex" data-i18n="print_label">Print</button>
        <button id="btn-pdf" class="btn hidden md:inline-flex" style="background:var(--brand-primary);border-color:transparent;color:#1a1a1a" data-i18n="pdf_download">Download PDF</button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-6xl mx-auto px-3 md:px-4 py-4 md:py-6 grid md:grid-cols-3 gap-4 md:gap-6" id="contentRoot" aria-live="polite">
    <!-- Left -->
    <section class="md:col-span-2 space-y-4">
      <div class="rounded-2xl shadow-sm" style="background:var(--card); border:1px solid var(--line);">
        <!-- Head -->
        <div class="p-3 md:p-4 flex items-center justify-between gap-3 border-b" style="border-color:var(--line)">
          <div>
            <h2 class="text-base md:text-lg font-semibold" data-i18n="history_title">Historiek</h2>
            <div id="seasonLabel" class="text-xs md:text-sm" style="color:var(--muted)"></div>
          </div>
          <!-- De bereik-selectie is verwijderd; het seizoen wordt nu altijd volledig weergegeven -->
        </div>

        <!-- KPI’s -->
        <div class="p-3 md:p-4 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 text-sm">
          <div><div class="text-xs" style="color:var(--muted)" data-i18n="kpi_quote">Notering</div><div id="kpi-quote" class="kpi">–</div></div>
          <div><div class="text-xs" style="color:var(--muted)" data-i18n="kpi_week">Week</div><div id="kpi-week" class="kpi">–</div></div>
          <div><div class="text-xs" style="color:var(--muted)" data-i18n="kpi_date">Datum</div><div id="kpi-date" class="kpi">–</div></div>
          <div class="col-span-2 md:col-span-1">
            <div class="text-xs" style="color:var(--muted)" data-i18n="kpi_sentiment">Marktstemming</div>
            <span id="kpi-sentiment" class="chip chip-slate mt-1">–</span>
          </div>
        </div>

        <!-- Notice geen notering -->
        <div id="noQuoteNotice" class="mx-3 md:mx-4 mb-3 notice hidden" data-i18n="no_quote_notice">Geen notering wegens gebrek aan transacties</div>

        <!-- Chart -->
        <div class="relative h-[320px] md:h-[420px] px-2 pb-2" id="chartWrap">
          <canvas id="chart" aria-label="Grafiek contractprijs & notering" role="img"></canvas>
          <div id="chartLoader" class="loading-overlay">
            <div class="flex items-center gap-2 text-sm">
              <div class="spinner" aria-hidden="true"></div>
              <span id="chartLoaderText">Data laden…</span>
            </div>
          </div>
        </div>

        <!-- Legende marktstemming -->
        <div class="p-3 md:p-4 border-t" style="border-color:var(--line)">
          <h3 class="font-semibold mb-2 text-sm md:text-base" data-i18n="legend_title">Legende marktstemming</h3>
          <ul class="list-disc pl-5 space-y-1 text-sm" id="legend_list"></ul>
        </div>

        <!-- Reglementering -->
        <div class="p-3 md:p-4 border-t text-sm md:text-[15px] leading-relaxed" style="border-color:var(--line)">
          <h3 class="font-semibold mb-2 text-sm md:text-base" data-i18n="rules_title">Reglementering & toelichting</h3>
          <div id="rules_body"></div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <aside class="space-y-4">
      <div class="rounded-2xl shadow-sm p-3 md:p-4 text-sm" style="background:var(--card); border:1px solid var(--line)">
        <p class="mb-1"><span data-i18n="last_update_label">Laatste update</span>: <span id="lastUpdate">–</span></p>
        <p class="mb-1" data-i18n="source" style="color:var(--muted)">Bron: interne rapportering</p>
        <p class="text-xs">© <span id="year"></span> Belgapom</p>
      </div>

      <div class="rounded-2xl shadow-sm p-3 md:p-4" style="background:var(--card); border:1px solid var(--line)">
        <div class="flex items-center justify-between gap-2">
          <strong data-i18n="table_title">Overzicht per week</strong>
          <div class="text-xs md:text-sm" id="tableSeason" style="color:var(--muted)"></div>
        </div>
        <!--
          Use a responsive max height class with Tailwind's arbitrary value syntax. The original
          class `max-h=[360px]` is invalid; this new class fixes the layout on mobile.
        -->
        <div class="relative max-h-[360px] md:max-h-[520px] overflow-auto mt-3 rounded-lg ring-1" style="--tw-ring-color:var(--line)">
          <div id="tableLoader" class="loading-overlay">
            <div class="flex items-center gap-2 text-sm">
              <div class="spinner" aria-hidden="true"></div>
              <span id="tableLoaderText">Tabel laden…</span>
            </div>
          </div>
          <table class="w-full text-[13px] md:text-sm">
            <thead class="sticky top-0" style="background:var(--card); color:var(--muted); border-bottom:1px solid var(--line)">
              <tr>
                <th class="text-left py-2 px-2" data-i18n="th_week">Week</th>
                <th class="text-left py-2 px-2" data-i18n="th_date">Datum (vr)</th>
                <th class="text-left py-2 px-2" data-i18n="th_contract">Contract</th>
                <th class="text-left py-2 px-2" data-i18n="th_quote">Notering</th>
                <th class="text-left py-2 px-2" data-i18n="th_sent">Stemming</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

  <!-- Mobile sticky actions -->
  <div class="fixed bottom-3 inset-x-0 px-3 md:hidden no-print z-30">
    <div class="max-w-6xl mx-auto">
      <div class="flex gap-2 p-2 rounded-2xl shadow-lg" style="background:var(--card); border:1px solid var(--line)">
        <button id="m-print" class="flex-1 btn" data-i18n="print_label">Print</button>
        <button id="m-pdf" class="flex-1 btn-active" data-i18n="pdf_download">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
  const APP_SCRIPT_JSON_URL = "https://script.google.com/macros/s/AKfycbwVrSmrvHI3y4rdYCaWlO4ePg9SqMoQq6l2cV2DUlVZFwDqbruxYMxLVCsRcTAjfOs2iQ/exec?mode=json";

  /* I18N */
  let LANG = (new URLSearchParams(location.search).get('lang')) || 'nl';
  const T = {
    nl:{ title:"Belgapom – Notering", subtitle:"Contractprijzen en wekelijkse notering (vrije aardappelen)",
      history_title:"Historiek",
      kpi_quote:"Notering", kpi_week:"Week", kpi_date:"Datum", kpi_sentiment:"Marktstemming",
      last_update_label:"Laatste update", source:"Bron: interne rapportering",
      table_title:"Overzicht per week", th_week:"Week", th_date:"Datum (vr)", th_contract:"Contract", th_quote:"Notering", th_sent:"Stemming",
      legend_title:"Legende marktstemming",
      legend_items:["Flauw — aanbod is groter dan de vraag","Rustig — aanbod is groter dan of gelijk aan de vraag","Stabiel — aanbod is gelijk aan de vraag (evenwicht)","Prijshoudend — aanbod is kleiner dan of gelijk aan de vraag","Vast — aanbod is kleiner dan de vraag"],
      rules_title:"Reglementering & toelichting",
      rules_body:[
        "Vrije markt en contracten in de Belgische diepvriesfrietsector:",
        "De wekelijkse Belgapomnotering voor vroege aardappelen (juli–augustus) en voor Fontane & Challenger (bewaarseizoen) geeft een duidelijke indicatie van de evolutie op de vrije aardappelmarkt voor verwerking tot diepvriesfriet.",
        "Daarnaast maken telers, handel en verwerking in toenemende mate gebruik van teeltcontracten, die grotere prijsstabiliteit beogen. De verhouding verschilt per bedrijf; beide componenten zijn relevant om de grondstofprijs te volgen.",
        "Daarom toont de grafiek naast de notering ook de evolutie van contractprijzen."
      ],
      loading_chart:"Data laden…", loading_table:"Tabel laden…", loading_error:"Kon data niet laden: "
      ,pdf_download:"Download PDF"
      ,no_quote_notice:"Geen notering wegens gebrek aan transacties"
      ,print_label:"Print"
    },
    fr:{ title:"Belgapom – Cotation", subtitle:"Prix contractuels et cotation hebdomadaire (pommes de terre libres)",
      history_title:"Historique",
      kpi_quote:"Cotation", kpi_week:"Semaine", kpi_date:"Date", kpi_sentiment:"Tendance du marché",
      last_update_label:"Dernière mise à jour", source:"Source : reporting interne",
      table_title:"Aperçu par semaine", th_week:"Semaine", th_date:"Date (ven)", th_contract:"Contrat", th_quote:"Cotation", th_sent:"Ambiance",
      legend_title:"Légende – tendance du marché",
      legend_items:["Faible — l'offre est supérieure à la demande","Calme — l'offre est supérieure ou égale à la demande","Stable — l'offre est égale à la demande (équilibre)","Soutenu — l'offre est inférieure ou égale à la demande","Ferme — l'offre est inférieure à la demande"],
      rules_title:"Réglementation & explications",
      rules_body:[
        "Marché libre et contrats dans le secteur belge des frites surgelées :",
        "La cotation hebdomadaire de Belgapom pour les pommes de terre précoces (juillet–août) et pour Fontane & Challenger (saison de conservation) indique clairement l’évolution du marché libre.",
        "Parallèlement, producteurs, commerce et industrie recourent de plus en plus aux contrats de culture afin de stabiliser le prix de la matière première.",
        "C’est pourquoi le graphique affiche également l’évolution des prix contractuels."
      ],
      loading_chart:"Chargement des données…", loading_table:"Chargement du tableau…", loading_error:"Impossible de charger les données : "
      ,pdf_download:"Télécharger PDF"
      ,no_quote_notice:"Pas de cotation faute de transactions"
      ,print_label:"Imprimer"
    },
    en:{ title:"Belgapom – Quotation", subtitle:"Contract prices and weekly quotation (free potatoes)",
      history_title:"History",
      kpi_quote:"Quotation", kpi_week:"Week", kpi_date:"Date", kpi_sentiment:"Market sentiment",
      last_update_label:"Last update", source:"Source: internal reporting",
      table_title:"Overview per week", th_week:"Week", th_date:"Date (Fri)", th_contract:"Contract", th_quote:"Quotation", th_sent:"Sentiment",
      legend_title:"Legend – market sentiment",
      legend_items:["Weak — supply exceeds demand","Calm — supply ≥ demand","Stable — supply = demand (equilibrium)","Supported — supply ≤ demand","Firm — supply < demand"],
      rules_title:"Regulation & explanation",
      rules_body:[
        "Free market and contracts in the Belgian frozen-fries sector:",
        "The weekly Belgapom quotation for early potatoes (July–August) and for Fontane & Challenger (storage season) indicates developments in the free market.",
        "Growers, traders and processors increasingly use production contracts to stabilise raw-material prices.",
        "Therefore, the chart shows contract price evolution alongside the weekly quotation."
      ],
      loading_chart:"Loading data…", loading_table:"Loading table…", loading_error:"Could not load data: "
      ,pdf_download:"Download PDF"
      ,no_quote_notice:"No quotation due to lack of transactions"
      ,print_label:"Print"
    }
  };
  function applyI18N(){
    const d=T[LANG];
    document.getElementById('title').textContent=d.title;
    document.getElementById('subtitle').textContent=d.subtitle;
    document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(d[k]) el.textContent=d[k]; });
    const ul=document.getElementById('legend_list'); ul.innerHTML='';
    d.legend_items.forEach(txt=>{ const li=document.createElement('li'); li.innerHTML=txt.replace(/^([^—-]+)/,'<strong>$1</strong>'); ul.appendChild(li); });
    document.getElementById('rules_body').innerHTML=d.rules_body.map(p=>`<p class="mb-2">${p}</p>`).join('');
    document.getElementById('chartLoaderText').textContent=d.loading_chart;
    document.getElementById('tableLoaderText').textContent=d.loading_table;
  }

  /* helpers */
  const euro = v => (v==null||v==='') ? '–' : new Intl.NumberFormat(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE', {style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
  const toNum = v => {
    if (v==null||v==='') return null;
    if (typeof v==='number') return isFinite(v)&&v>0 ? v : null;
    const s=String(v).replace(/[€\s]/g,'').replace(',','.');
    const n=Number(s); return isFinite(n)&&n>0 ? n : null;
  };
  function formatDateISO(iso){ if(!iso) return '–'; const d=new Date(iso+'T00:00:00'); const loc=LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE'; return d.toLocaleDateString(loc,{day:'2-digit',month:'2-digit',year:'numeric'}); }
  function isoWeekMetaJS(dateObj){ const date=new Date(dateObj); const dayNr=(date.getDay()+6)%7; const thu=new Date(date); thu.setDate(date.getDate()-dayNr+3); const firstThu=new Date(thu.getFullYear(),0,4); const ftDay=(firstThu.getDay()+6)%7; firstThu.setDate(firstThu.getDate()-ftDay+3); const week=1+Math.round((thu-firstThu)/(7*24*3600*1000)); const year=thu.getFullYear(); return {week,year}; }

  /* state */
  let chart, allRows=[], seasonRows=[], seasonStartYear, latestRow, contractKey='contract_price';
  let currentRange='season'; // '2' | '4' | '8' | 'season'

  const showLoaders=()=>{
    document.getElementById('chartLoader').classList.remove('loading-hidden');
    document.getElementById('tableLoader').classList.remove('loading-hidden');
  };
  const hideLoaders=()=>{
    document.getElementById('chartLoader').classList.add('loading-hidden');
    document.getElementById('tableLoader').classList.add('loading-hidden');
  };
  function setActive(groupSelector, value, attr){ document.querySelectorAll(groupSelector).forEach(b=>{ if (String(b.getAttribute(attr))===String(value)) b.classList.add('btn-active'); else b.classList.remove('btn-active'); }); }

  function renderKPI(){
    document.getElementById('kpi-quote').textContent = euro(toNum(latestRow.notering));
    document.getElementById('kpi-week').textContent  = String(latestRow.week_num).padStart(2,'0');
    document.getElementById('kpi-date').textContent  = formatDateISO(latestRow.friday_date);

    const noQuote = (latestRow.notering==null || latestRow.notering==='');
    const notice=document.getElementById('noQuoteNotice');
    if(noQuote){ notice.classList.remove('hidden'); }
    else { notice.classList.add('hidden'); }

    const b=document.getElementById('kpi-sentiment');
    b.textContent=latestRow.marktstemming||'–';
    const s=(latestRow.marktstemming||'').toLowerCase();
    b.className='chip mt-1 '+(
      s.includes('vast')||s.includes('ferme')||s.includes('firm') ? 'chip-green' :
      s.includes('houd')||s.includes('soutenu')||s.includes('support') ? 'chip-slate' :
      s.includes('stabiel')||s.includes('stable') ? 'chip-slate' :
      s.includes('rustig')||s.includes('calme')||s.includes('calm') ? 'chip-slate' :
      s.includes('flauw')||s.includes('faible')||s.includes('weak')||s.includes('neg') ? 'chip-red' : 'chip-slate'
    );
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE',{timeZone:'Europe/Brussels'});
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  function buildSeries(){
    const rows=[...seasonRows].sort((a,b)=> a.friday_date.localeCompare(b.friday_date));
    const working = (currentRange==='season') ? rows : rows.slice(-Number(currentRange));
    const labels = working.map(r=> r.week_label);

    const contract = working.map(r=> toNum(r[contractKey]));
    const quote    = working.map(r=> toNum(r.notering));
    const vals=[...contract,...quote].filter(Number.isFinite);
    let yMin=0,yMax=100,yStep=10;
    if(vals.length){ const lo=Math.min(...vals), hi=Math.max(...vals), span=hi-lo, pad=Math.max(10,Math.round(span*0.12)); const nice=(sp)=>{ const t=Math.max(1,sp/6), p=10**Math.floor(Math.log10(t)), b=t/p; return (b<=1?1:b<=2?2:b<=5?5:10)*p; }; yStep=nice(span||10); yMin=Math.max(0,Math.floor((lo-pad)/yStep)*yStep); yMax=Math.ceil((hi+pad)/yStep)*yStep; if(yMax<=yMin) yMax=yMin+yStep; }
    return { labels, contract, quote, yMin, yMax, yStep };
  }

  function renderChart(){
    const { labels, contract, quote, yMin, yMax, yStep } = buildSeries();
    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          { label: LANG==='fr'?'Prix contractuel (€/t)':LANG==='en'?'Contract price (€/t)':'Contractprijs (€/t)',
            data: contract, borderWidth:3, pointRadius:3.5, tension:0, stepped:true,
            borderColor:getComputedStyle(document.documentElement).getPropertyValue('--brand-neutral').trim(),
            backgroundColor:'transparent', spanGaps:false },
          { label: LANG==='fr'?'Cotation (€/t)':LANG==='en'?'Quotation (€/t)':'Notering (€/t)',
            data: quote, borderWidth:3, pointRadius:3.5, tension:0.2,
            borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent-quote').trim(),
            backgroundColor:'transparent', spanGaps:false }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'index', intersect:false},
        plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, boxHeight:12, usePointStyle:true } }, tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${euro(ctx.parsed.y)}` } } },
        scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:(window.innerWidth<640?6:14) }, grid:{ display:false } }, y:{ min:yMin, max:yMax, ticks:{ stepSize:yStep, callback:v=>`${v} €` }, grid:{ color:'rgba(0,0,0,0.06)' } } }
      }
    });
  }

  function renderTable(){
    const tbody=document.getElementById('tbody'); tbody.innerHTML='';
    const order=[...Array(17)].map((_,i)=>36+i).concat([...Array(36)].map((_,i)=>i+1));
    const byWeekC={}, byWeekQ={}, byWeekS={}, byWeekFri={};
    seasonRows.forEach(r=>{ const w=r.week_num; if (r.friday_date) byWeekFri[w]=r.friday_date; const c=toNum(r[contractKey]); if(c!=null) byWeekC[w]=c; const q=toNum(r.notering); if(q!=null) byWeekQ[w]=q; if (r.marktstemming) byWeekS[w]=r.marktstemming; });
    order.forEach(w=>{ const tr=document.createElement('tr'); tr.className="border-b"; tr.style.borderColor="var(--line)"; tr.innerHTML=`<td class="py-2 px-2">W${String(w).padStart(2,'0')}</td><td class="py-2 px-2">${formatDateISO(byWeekFri[w])}</td><td class="py-2 px-2">${euro(byWeekC[w])}</td><td class="py-2 px-2">${euro(byWeekQ[w])}</td><td class="py-2 px-2">${byWeekS[w] || '–'}</td>`; tbody.appendChild(tr); });
    document.getElementById('tableSeason').textContent=`W36 ${seasonStartYear} – W36 ${seasonStartYear+1}`;
  }

  async function makePDF(){ const { jsPDF } = window.jspdf; const doc=new jsPDF({ unit:'pt', format:'a4' }); const root=document.getElementById('contentRoot'); doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(17,24,39); doc.text(document.getElementById('title').textContent, 40, 40); doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(80); doc.text(document.getElementById('subtitle').textContent, 40, 58); const chartCard=root.querySelector('section > div'); const tableCard=root.querySelector('aside > div:nth-child(2)'); const pad=24; let y=80; async function addBlock(el){ const canvas=await html2canvas(el,{ scale:2, backgroundColor:null }); const img=canvas.toDataURL('imagePNG'); const pageW=doc.internal.pageSize.getWidth(); const maxW=pageW-2*40; const ratio=canvas.width/canvas.height; const w=Math.min(maxW, canvas.width); const h=w/ratio; if(y+h>doc.internal.pageSize.getHeight()-40){ doc.addPage(); y=40;} doc.addImage(img,'PNG',40,y,w,h,undefined,'FAST'); y+=h+pad; } await addBlock(chartCard); await addBlock(tableCard); const fname=`belgapom-notering_${new Date().toISOString().slice(0,10)}.pdf`; doc.save(fname); }

  /*
   * Revised PDF generator that scales content to fit the available page area. The legacy
   * makePDF() remains for compatibility, but the UI will call this improved version.
   */
  async function makePDFImproved(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const root = document.getElementById('contentRoot');
    // Draw header on first page
    doc.setFont('helvetica','bold');
    doc.setFontSize(14);
    doc.setTextColor(17,24,39);
    doc.text(document.getElementById('title').textContent, 40, 40);
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    doc.setTextColor(80);
    doc.text(document.getElementById('subtitle').textContent, 40, 58);
    const chartCard = root.querySelector('section > div');
    const tableCard = root.querySelector('aside > div:nth-child(2)');
    const pad = 24;
    let y = 80;
    async function addBlock(el){
      const canvas = await html2canvas(el, { scale:2, backgroundColor:null });
      const imgData = canvas.toDataURL('imagePNG');
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 40;
      let w = canvas.width;
      let h = canvas.height;
      // Fit width
      const maxW = pageW - 2*margin;
      if (w > maxW) {
        const s = maxW / w;
        w = maxW;
        h = h * s;
      }
      // Fit height
      const availH = pageH - margin - y;
      if (h > availH && h > 0) {
        const s = availH / h;
        if (s < 1) {
          w = w * s;
          h = h * s;
        }
      }
      // New page if needed
      if (y + h > pageH - margin) {
        doc.addPage();
        y = margin;
      }
      doc.addImage(imgData, 'PNG', margin, y, w, h, undefined, 'FAST');
      y += h + pad;
    }
    await addBlock(chartCard);
    await addBlock(tableCard);
    const fname = `belgapom-notering_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(fname);
  }

  async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); const t=await r.text(); if(!t) throw new Error('Lege respons'); if(t.trim().startsWith('<')) throw new Error('HTML i.p.v. JSON'); return JSON.parse(t); }

  (async function init(){
    applyI18N();

    const setLang = (l)=>{ LANG=l; applyI18N(); renderKPI(); renderChart(); renderTable(); };
    document.getElementById('btn-nl').onclick=()=>setLang('nl');
    document.getElementById('btn-fr').onclick=()=>setLang('fr');
    document.getElementById('btn-en').onclick=()=>setLang('en');

    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('m-print').onclick=()=>window.print();
    // Use improved PDF generator for better layout on export
    document.getElementById('btn-pdf').onclick=makePDFImproved;
    document.getElementById('m-pdf').onclick=makePDFImproved;

    // Bereik-selectie is verwijderd; het seizoen wordt altijd volledig getoond

    try{
      const data=await fetchJSON(APP_SCRIPT_JSON_URL);
      const rows = Array.isArray(data.rows) ? data.rows : [];
      if(!rows.length) throw new Error('Geen rijen in feed');
      allRows = rows;

      contractKey = ['contract_price','contractprijs','contract'].find(k=>k in allRows[0]) || 'contract_price';

      const last = allRows[allRows.length-1];
      const suggested = data.meta && data.meta.suggested_season_start_year;
      seasonStartYear = suggested ?? (last.week_num>=36 ? last.week_year : last.week_year-1);

      function isoWeekStart(y,w){ const simple=new Date(y,0,1+(w-1)*7); let dow=simple.getDay(); if(dow===0) dow=7; const mon=new Date(simple); mon.setDate(simple.getDate()-dow+1); return new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()); }
      const start = isoWeekStart(seasonStartYear,36);
      const endMon = isoWeekStart(seasonStartYear+1,36); const end = new Date(endMon); end.setDate(endMon.getDate()+6);
      seasonRows = allRows.filter(r=>{ const d=new Date((r.friday_date||r.date)+'T00:00:00'); return d>=start && d<=end; });

      const cutoffIso = (data.meta && data.meta.latest_cutoff_friday_iso) ? data.meta.latest_cutoff_friday_iso : (()=>{ const nowBE=new Date(new Date().toLocaleString('en-US',{timeZone:'Europe/Brussels'})); const dow=nowBE.getDay(); const dsf=(dow>=5)?(dow-5):(dow+2); const lf=new Date(nowBE); lf.setDate(nowBE.getDate()-dsf); return lf.toISOString().slice(0,10); })();
      const cutoffDateObj = new Date(cutoffIso+'T00:00:00');
      const target = isoWeekMetaJS(cutoffDateObj);

      let lr = seasonRows.find(r => r.week_num===target.week && r.week_year===target.year);
      if (!lr) lr = { week_num: target.week, week_year: target.year, friday_date: cutoffIso, notering: null, contract_price: null, marktstemming: '' };
      latestRow = lr;

      document.getElementById('seasonLabel').textContent=`W36 ${seasonStartYear} – W36 ${seasonStartYear+1}`;

      renderKPI();
      renderChart();
      renderTable();

      // hide loaders once everything has been rendered
      hideLoaders();
    }catch(err){
      const d=T[LANG]||T.nl;
      document.getElementById('chartLoaderText').textContent = (d.loading_error||'Kon data niet laden: ')+err.message;
      document.getElementById('tableLoaderText').textContent  = (d.loading_error||'Kon data niet laden: ')+err.message;
      // Always hide loaders on error so the user sees the message
      hideLoaders();
    }
  })();
  </script>
</body>
</html>
