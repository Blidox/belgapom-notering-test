<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="assets/Asset%201.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belgapom – Notering / Cotation / Quotation</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <!-- PDF (print-friendly export) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --brand-primary:#FFCA00; --brand-neutral:#3f3f3f; --accent-quote:#2aa36b;
      --bg:#f7f7f8; --ink:#111827; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb;
    }
    html,body{ background:var(--bg); color:var(--ink); }
    .btn{ padding:.55rem .8rem; border-radius:0.75rem; border:1px solid var(--line); background:var(--card); font-size:.95rem }
    .btn-active{ background:var(--brand-primary); color:#1a1a1a; border-color:transparent; font-weight:700; }
    .chip{ display:inline-block; padding:.25rem .75rem; border-radius:999px; font-size:.78rem; font-weight:700 }
    .chip-green{ background:var(--accent-quote); color:white; }
    .chip-slate{ background:#475569; color:white; }
    .chip-red{ background:#b91c1c; color:white; }
    .kpi{ font-size:clamp(1.15rem, 2.6vw, 1.5rem); font-weight:800 }
    .spinner{ width:22px;height:22px;border:3px solid rgba(0,0,0,.15);border-top-color:rgba(0,0,0,.6);border-radius:50%;animation:spin .9s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.85);backdrop-filter:blur(2px)}
    .loading-hidden{display:none!important}
    .notice{background:#fff7d6;border:1px solid #f2e4a3;color:#5b4a00;padding:.5rem .75rem;border-radius:.75rem;font-size:.9rem}
    @media print { .no-print { display:none !important } }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="sticky top-0 z-20 border-b bg-white/90 backdrop-blur" style="border-color:var(--line)">
    <div class="max-w-6xl mx-auto px-3 md:px-4 py-2 md:py-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="assets/belgapom-logo.svg" alt="Belgapom" class="h-8 w-auto"/>
        <div>
          <h1 id="title" class="font-semibold text-base md:text-lg">Belgapom – Notering</h1>
          <p id="subtitle" class="text-xs md:text-sm" style="color:var(--muted)">Contractprijzen en wekelijkse notering (vrije aardappelen)</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-1 md:gap-2 no-print mt-2 sm:mt-0">
        <button id="btn-nl" class="btn">NL</button>
        <button id="btn-fr" class="btn">FR</button>
        <button id="btn-en" class="btn">EN</button>
        <button id="btn-print" class="btn hidden md:inline-flex" data-i18n="print_label">Print</button>
        <button id="btn-pdf" class="btn hidden md:inline-flex" style="background:var(--brand-primary);border-color:transparent;color:#1a1a1a" data-i18n="pdf_download">Download PDF</button>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="max-w-6xl mx-auto px-3 md:px-4 py-4 md:py-6 grid md:grid-cols-3 gap-4 md:gap-6" id="contentRoot" aria-live="polite">
    <!-- Left -->
    <section class="md:col-span-2 space-y-4">
      <div class="rounded-2xl shadow-sm" style="background:var(--card); border:1px solid var(--line);">
        <!-- Head -->
        <div class="p-3 md:p-4 flex items-center justify-between gap-3 border-b" style="border-color:var(--line)">
          <div class="flex-1">
            <h2 class="text-base md:text-lg font-semibold" data-i18n="current_period_title">Huidige periode</h2>
            <div id="seasonLabel" class="text-xs md:text-sm" style="color:var(--muted)"></div>
          </div>
        </div>

        <!-- KPI’s -->
        <div class="p-3 md:p-4 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 text-sm">
          <div><div class="text-xs" style="color:var(--muted)" data-i18n="kpi_quote">Notering</div><div id="kpi-quote" class="kpi">–</div></div>
          <div><div class="text-xs" style="color:var(--muted)" data-i18n="kpi_week">Week</div><div id="kpi-week" class="kpi">–</div></div>
          <div><div class="text-xs" style="color:var(--muted)" data-i18n="kpi_date">Datum</div><div id="kpi-date" class="kpi">–</div></div>
          <div class="col-span-2 md:col-span-1">
            <div class="text-xs" style="color:var(--muted)" data-i18n="kpi_sentiment">Marktstemming</div>
            <span id="kpi-sentiment" class="chip chip-slate mt-1">–</span>
          </div>
        </div>

        <!-- Notice geen notering -->
        <div id="noQuoteNotice" class="mx-3 md:mx-4 mb-3 notice hidden" data-i18n="no_quote_notice">Geen notering wegens gebrek aan transacties</div>

        <!-- Season selector + Chart -->
        <div class="relative h-[340px] md:h-[440px] px-2 pb-2" id="chartWrap">
          <div class="flex items-center gap-2 text-xs md:text-sm mb-2">
            <label for="seasonSelect" data-i18n="season_label" class="whitespace-nowrap">Seizoen:</label>
            <select id="seasonSelect" class="border rounded px-2 py-1"></select>
          </div>

          <canvas id="chart" aria-label="Grafiek contractprijs & notering" role="img"></canvas>
          <div id="chartLoader" class="loading-overlay">
            <div class="flex items-center gap-2 text-sm">
              <div class="spinner" aria-hidden="true"></div>
              <span id="chartLoaderText">Data laden…</span>
            </div>
          </div>
        </div>

        <!-- Legende marktstemming -->
        <div class="p-3 md:p-4 border-t" style="border-color:var(--line)">
          <h3 class="font-semibold mb-2 text-sm md:text-base" data-i18n="legend_title">Legende marktstemming</h3>
          <ul class="list-disc pl-5 space-y-1 text-sm" id="legend_list"></ul>
        </div>

        <!-- Reglementering -->
        <div class="p-3 md:p-4 border-t text-sm md:text-[15px] leading-relaxed" style="border-color:var(--line)">
          <h3 class="font-semibold mb-2 text-sm md:text-base" data-i18n="rules_title">Reglementering & toelichting</h3>
          <div id="rules_body"></div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <aside class="space-y-4">
      <div class="rounded-2xl shadow-sm p-3 md:p-4 text-sm" style="background:var(--card); border:1px solid var(--line)">
        <p class="mb-1"><span data-i18n="last_update_label">Laatste update</span>: <span id="lastUpdate">–</span></p>
        <p class="mb-1" data-i18n="source" style="color:var(--muted)">Bron: interne rapportering</p>
        <p class="text-xs">© <span id="year"></span> Belgapom</p>
      </div>

      <div class="rounded-2xl shadow-sm p-3 md:p-4" style="background:var(--card); border:1px solid var(--line)">
        <div class="flex items-center justify-between gap-2">
          <strong data-i18n="table_title">Overzicht per week</strong>
          <div class="text-xs md:text-sm" id="tableSeason" style="color:var(--muted)"></div>
        </div>
        <div class="relative max-h-[360px] md:max-h-[520px] overflow-auto mt-3 rounded-lg ring-1" style="--tw-ring-color:var(--line)">
          <div id="tableLoader" class="loading-overlay">
            <div class="flex items-center gap-2 text-sm">
              <div class="spinner" aria-hidden="true"></div>
              <span id="tableLoaderText">Tabel laden…</span>
            </div>
          </div>
          <table class="w-full text-[13px] md:text-sm">
            <thead class="sticky top-0" style="background:var(--card); color:var(--muted); border-bottom:1px solid var(--line)">
              <tr>
                <th class="text-left py-2 px-2" data-i18n="th_week">Week</th>
                <th class="text-left py-2 px-2" data-i18n="th_date">Datum (vr)</th>
                <th class="text-left py-2 px-2" data-i18n="th_contract">Contract</th>
                <th class="text-left py-2 px-2" data-i18n="th_quote">Notering</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

  <!-- PRIMEURS (TABBLADEN + TABEL, geen grafiek) -->
  <section class="max-w-6xl mx-auto px-3 md:px-4 pb-8" id="primeursSection" style="display:none">
    <div class="rounded-2xl shadow-sm" style="background:var(--card); border:1px solid var(--line);">
      <div class="p-3 md:p-4 border-b" style="border-color:var(--line)">
        <h3 class="font-semibold text-base md:text-lg" data-i18n="primeurs_title">Historiek primeurs</h3>
        <p class="text-xs md:text-sm mt-1" style="color:var(--muted)"><span data-i18n="primeurs_hint">Periode 15 juli – 15 september; enkel notering (geen contractprijzen). Lege notering = geen notering wegens gebrek aan transacties.</span></p>
      </div>
      <div class="p-3 md:p-4 border-b" style="border-color:var(--line)">
        <div id="primeurTabs" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="p-3 md:p-4">
        <div class="relative max-h-[360px] md:max-h-[520px] overflow-auto rounded-lg ring-1" style="--tw-ring-color:var(--line)">
          <div id="primeursTableLoader" class="loading-overlay loading-hidden">
            <div class="flex items-center gap-2 text-sm">
              <div class="spinner"></div>
              <span id="primeursTableLoaderText">Tabel laden…</span>
            </div>
          </div>
          <table class="w-full text-[13px] md:text-sm">
            <thead class="sticky top-0" style="background:var(--card); color:var(--muted); border-bottom:1px solid var(--line)">
              <tr>
                <th class="text-left py-2 px-2" data-i18n="primeurs_th_week">Week</th>
                <th class="text-left py-2 px-2" data-i18n="primeurs_th_date">Datum</th>
                <th class="text-left py-2 px-2" data-i18n="primeurs_th_quote">Notering</th>
              </tr>
            </thead>
            <tbody id="primeursTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Mobile sticky actions -->
  <div class="fixed bottom-3 inset-x-0 px-3 md:hidden no-print z-30">
    <div class="max-w-6xl mx-auto">
      <div class="flex gap-2 p-2 rounded-2xl shadow-lg" style="background:var(--card); border:1px solid var(--line)">
        <button id="m-print" class="flex-1 btn" data-i18n="print_label">Print</button>
        <button id="m-pdf" class="flex-1 btn-active" data-i18n="pdf_download" style="background:var(--brand-primary);border-color:transparent;color:#1a1a1a">Download PDF</button>
      </div>
    </div>
  </div>

  <script>
  /* >>> VERVANG door jouw exec-URL */
  const APP_SCRIPT_JSON_URL = "https://script.google.com/macros/s/AKfycbwM9BLrMt1PJBzXc5ZhwLY94MBQvudnCTLr1D-T3JQIsu_edvDk4CelE4avnaE9e5rn/exec?mode=json";

  /* I18N */
  let LANG = (new URLSearchParams(location.search).get('lang')) || 'nl';
  const T = {
    nl:{ title:"Belgapom – Notering", subtitle:"Contractprijzen en wekelijkse notering (vrije aardappelen)",
      current_period_title:"Huidige periode",
      kpi_quote:"Notering", kpi_week:"Week", kpi_date:"Datum", kpi_sentiment:"Marktstemming",
      last_update_label:"Laatste update", source:"Bron: interne rapportering",
      table_title:"Overzicht per week", th_week:"Week", th_date:"Datum (vr)", th_contract:"Contract", th_quote:"Notering",
      legend_title:"Legende marktstemming",
      legend_items:["Flauw — aanbod is groter dan de vraag","Rustig — aanbod is groter dan of gelijk aan de vraag","Stabiel — aanbod is gelijk aan de vraag (evenwicht)","Prijshoudend — aanbod is kleiner dan of gelijk aan de vraag","Vast — aanbod is kleiner dan de vraag"],
      rules_title:"Reglementering & toelichting",
      rules_body:[
        "Vrije markt en contracten in de Belgische diepvriesfrietsector:",
        "De wekelijkse Belgapomnotering voor vroege aardappelen (juli–augustus) en voor Fontane & Challenger (bewaarseizoen) geeft een duidelijke indicatie van de evolutie op de vrije aardappelmarkt.",
        "Daarnaast maken telers, handel en verwerking gebruik van teeltcontracten voor prijsstabiliteit.",
        "Daarom toont de grafiek naast de notering ook de evolutie van contractprijzen."
      ],
      loading_chart:"Data laden…", loading_table:"Tabel laden…", loading_error:"Kon data niet laden: ",
      no_quote_notice:"Geen notering wegens gebrek aan transacties",
      season_label:"Seizoen",
      primeurs_title:"Historiek primeurs",
      primeurs_hint:"Periode 15 juli – 15 september; enkel notering (geen contractprijzen). Lege notering = geen notering wegens gebrek aan transacties.",
      primeurs_th_week:"Week", primeurs_th_date:"Datum", primeurs_th_quote:"Notering",
      pdf_download:"Download PDF", print_label:"Print"
    },
    fr:{ title:"Belgapom – Cotation", subtitle:"Prix contractuels et cotation hebdomadaire (pommes de terre libres)",
      current_period_title:"Période actuelle",
      kpi_quote:"Cotation", kpi_week:"Semaine", kpi_date:"Date", kpi_sentiment:"Tendance du marché",
      last_update_label:"Dernière mise à jour", source:"Source : reporting interne",
      table_title:"Aperçu par semaine", th_week:"Semaine", th_date:"Date (ven)", th_contract:"Contrat", th_quote:"Cotation",
      legend_title:"Légende – tendance du marché",
      legend_items:["Faible — l’offre > la demande","Calme — l’offre ≥ la demande","Stable — équilibre","Soutenu — l’offre ≤ la demande","Ferme — l’offre < la demande"],
      rules_title:"Réglementation & explications",
      rules_body:[
        "Marché libre et contrats dans le secteur belge des frites surgelées.",
        "La cotation hebdomadaire (précoces et saison de stockage) reflète l’évolution du marché libre.",
        "Les contrats de culture assurent davantage de stabilité des prix.",
        "Le graphique montre donc prix contractuels et cotation."
      ],
      loading_chart:"Chargement des données…", loading_table:"Chargement du tableau…", loading_error:"Impossible de charger les données : ",
      no_quote_notice:"Pas de cotation faute de transactions",
      season_label:"Saison",
      primeurs_title:"Historique primeurs",
      primeurs_hint:"15 juillet – 15 septembre; uniquement cotation. Valeur vide = pas de cotation (manque de transactions).",
      primeurs_th_week:"Sem.", primeurs_th_date:"Date", primeurs_th_quote:"Cotation",
      pdf_download:"Télécharger PDF", print_label:"Imprimer"
    },
    en:{ title:"Belgapom – Quotation", subtitle:"Contract prices and weekly quotation (free potatoes)",
      current_period_title:"Current period",
      kpi_quote:"Quotation", kpi_week:"Week", kpi_date:"Date", kpi_sentiment:"Market sentiment",
      last_update_label:"Last update", source:"Source: internal reporting",
      table_title:"Overview per week", th_week:"Week", th_date:"Date (Fri)", th_contract:"Contract", th_quote:"Quotation",
      legend_title:"Legend – market sentiment",
      legend_items:["Weak — supply > demand","Calm — supply ≥ demand","Stable — equilibrium","Supported — supply ≤ demand","Firm — supply < demand"],
      rules_title:"Regulation & explanation",
      rules_body:[
        "Free market and contracts in the Belgian frozen-fries sector.",
        "The weekly quotation (early potatoes and storage season) reflects free-market moves.",
        "Production contracts add price stability.",
        "So the chart shows both contract price and quotation."
      ],
      loading_chart:"Loading data…", loading_table:"Loading table…", loading_error:"Could not load data: ",
      no_quote_notice:"No quotation due to lack of transactions",
      season_label:"Season",
      primeurs_title:"Early potatoes – history",
      primeurs_hint:"15 July – 15 September; quotation only. Empty value = no quotation (lack of transactions).",
      primeurs_th_week:"Week", primeurs_th_date:"Date", primeurs_th_quote:"Quotation",
      pdf_download:"Download PDF", print_label:"Print"
    }
  };
  function applyI18N(){
    const d=T[LANG];
    document.getElementById('title').textContent=d.title;
    document.getElementById('subtitle').textContent=d.subtitle;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k=el.getAttribute('data-i18n'); if(d[k]) el.textContent=d[k];
    });
    const ul=document.getElementById('legend_list'); ul.innerHTML='';
    d.legend_items.forEach(txt=>{ const li=document.createElement('li'); li.innerHTML=txt.replace(/^([^—-]+)/,'<strong>$1</strong>'); ul.appendChild(li); });
    document.getElementById('rules_body').innerHTML=d.rules_body.map(p=>`<p class="mb-2">${p}</p>`).join('');
    const cl=document.getElementById('chartLoaderText'); if(cl) cl.textContent=d.loading_chart;
    const tl=document.getElementById('tableLoaderText'); if(tl) tl.textContent=d.loading_table;
  }

  /* helpers */
  const euro = v => (v==null||v==='') ? '–' : new Intl.NumberFormat(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE', {style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
  const toNum = v => {
    if (v==null||v==='') return null;
    if (typeof v==='number') return isFinite(v)&&v>0 ? v : null;
    const s=String(v).replace(/[€\s]/g,'').replace(',','.');
    const n=Number(s); return isFinite(n)&&n>0 ? n : null;
  };
  function formatDateISO(iso){ if(!iso) return '–'; const d=new Date(iso+'T00:00:00'); const loc=LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE'; return d.toLocaleDateString(loc,{day:'2-digit',month:'2-digit',year:'numeric'}); }
  function isoWeekMetaJS(dateObj){ const date=new Date(dateObj); const dayNr=(date.getDay()+6)%7; const thu=new Date(date); thu.setDate(date.getDate()-dayNr+3); const firstThu=new Date(thu.getFullYear(),0,4); const ftDay=(firstThu.getDay()+6)%7; firstThu.setDate(firstThu.getDate()-ftDay+3); const week=1+Math.round((thu-firstThu)/(7*24*3600*1000)); const year=thu.getFullYear(); return {week,year}; }
  function isoWeekStart(y,w){ const simple=new Date(y,0,1+(w-1)*7); let dow=simple.getDay(); if(dow===0) dow=7; const mon=new Date(simple); mon.setDate(simple.getDate()-dow+1); return new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()); }

  /* state */
  let chart, allRows=[], seasonRows=[], seasonStartYear, latestOverallRow, contractKey='contract_price';
  let primeurRows=[], primeurYears=[], currentPrimeurYear=null;

  const showLoaders=()=>{ document.getElementById('chartLoader').classList.remove('loading-hidden'); document.getElementById('tableLoader').classList.remove('loading-hidden'); };
  const hideLoaders=()=>{ document.getElementById('chartLoader').classList.add('loading-hidden'); document.getElementById('tableLoader').classList.add('loading-hidden'); };

  function renderKPI(){
    const r = latestOverallRow;
    document.getElementById('kpi-quote').textContent = euro(toNum(r.notering));
    document.getElementById('kpi-week').textContent  = String(r.week_num).padStart(2,'0');
    document.getElementById('kpi-date').textContent  = formatDateISO(r.friday_date);
    const noQuote = (r.notering==null || r.notering==='');
    const notice=document.getElementById('noQuoteNotice');
    if(noQuote){ notice.classList.remove('hidden'); } else { notice.classList.add('hidden'); }
    const b=document.getElementById('kpi-sentiment'); b.textContent=r.marktstemming||'–';
    const s=(r.marktstemming||'').toLowerCase();
    b.className='chip mt-1 '+(
      s.includes('vast')||s.includes('ferme')||s.includes('firm') ? 'chip-green' :
      s.includes('houd')||s.includes('soutenu')||s.includes('support') ? 'chip-slate' :
      s.includes('stabiel')||s.includes('stable') ? 'chip-slate' :
      s.includes('rustig')||s.includes('calme')||s.includes('calm') ? 'chip-slate' :
      s.includes('flauw')||s.includes('faible')||s.includes('weak')||s.includes('neg') ? 'chip-red' : 'chip-slate'
    );
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE',{timeZone:'Europe/Brussels'});
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  function buildSeries(){
    const rows=[...seasonRows].sort((a,b)=> a.friday_date.localeCompare(b.friday_date));
    const labels = rows.map(r=> r.week_label);
    const contract = rows.map(r=> toNum(r[contractKey]));
    const quote    = rows.map(r=> toNum(r.notering));
    const vals=[...contract,...quote].filter(Number.isFinite);
    let yMin=0,yMax=100,yStep=10;
    if(vals.length){
      const lo=Math.min(...vals), hi=Math.max(...vals), span=hi-lo, pad=Math.max(10,Math.round(span*0.12));
      const nice=(sp)=>{ const t=Math.max(1,sp/6), p=10**Math.floor(Math.log10(t)), b=t/p; return (b<=1?1:b<=2?2:b<=5?5:10)*p; };
      yStep=nice(span||10); yMin=Math.max(0,Math.floor((lo-pad)/yStep)*yStep); yMax=Math.ceil((hi+pad)/yStep)*yStep; if(yMax<=yMin) yMax=yMin+yStep;
    }
    return { labels, contract, quote, yMin, yMax, yStep };
  }

  function renderChart(){
    const { labels, contract, quote, yMin, yMax, yStep } = buildSeries();
    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          { label: LANG==='fr'?'Prix contractuel (€/t)':LANG==='en'?'Contract price (€/t)':'Contractprijs (€/t)',
            data: contract, borderWidth:3, pointRadius:3.5, tension:0, stepped:true,
            borderColor:getComputedStyle(document.documentElement).getPropertyValue('--brand-neutral').trim(),
            backgroundColor:'transparent', spanGaps:false },
          { label: LANG==='fr'?'Cotation (€/t)':LANG==='en'?'Quotation (€/t)':'Notering (€/t)',
            data: quote, borderWidth:3, pointRadius:3.5, tension:0.2,
            borderColor:getComputedStyle(document.documentElement).getPropertyValue('--accent-quote').trim(),
            backgroundColor:'transparent', spanGaps:false }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'index', intersect:false},
        plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12, boxHeight:12, usePointStyle:true } }, tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${euro(ctx.parsed.y)}` } } },
        scales:{ x:{ ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:(window.innerWidth<640?6:14) }, grid:{ display:false } }, y:{ min:yMin, max:yMax, ticks:{ stepSize:yStep, callback:v=>`${v} €` }, grid:{ color:'rgba(0,0,0,0.06)' } } }
      }
    });
  }

  // Tabel: chronologisch (lost W36-bugs op) en zonder “Stemming”
  function renderTable(){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    const rows = [...seasonRows].sort((a,b)=> String(a.friday_date||a.date).localeCompare(String(b.friday_date||b.date)));
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.className = "border-b";
      tr.style.borderColor = "var(--line)";
      tr.innerHTML = `
        <td class="py-2 px-2">W${String(r.week_num).padStart(2,'0')}</td>
        <td class="py-2 px-2">${formatDateISO(r.friday_date || r.date)}</td>
        <td class="py-2 px-2">${euro(toNum(r[contractKey]))}</td>
        <td class="py-2 px-2">${euro(toNum(r.notering))}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('tableSeason').textContent=`W36 ${seasonStartYear} – W36 ${seasonStartYear+1}`;
  }

  // PRIMEURS (tabs + tabel)
  function renderPrimeursTabs(){
    const cont=document.getElementById('primeurTabs'); cont.innerHTML='';
    if(!primeurYears.length){ document.getElementById('primeursSection').style.display='none'; return; }
    document.getElementById('primeursSection').style.display='';
    primeurYears.forEach(y=>{
      const btn=document.createElement('button');
      btn.className='btn'; btn.textContent=String(y);
      if(y===currentPrimeurYear) btn.classList.add('btn-active');
      btn.onclick=()=>{ currentPrimeurYear=y; renderPrimeurs(); renderPrimeursTabs(); };
      cont.appendChild(btn);
    });
  }
  function renderPrimeurs(){
    const rows = primeurRows
      .filter(r=>{
        const d=new Date((r.date||r.friday_date)+'T00:00:00');
        return d.getFullYear()===currentPrimeurYear;
      })
      .sort((a,b)=> a.friday_date.localeCompare(b.friday_date));
    const tbody=document.getElementById('primeursTbody'); tbody.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr'); tr.className="border-b"; tr.style.borderColor="var(--line)";
      tr.innerHTML=`<td class="py-2 px-2">W${String(r.week_num).padStart(2,'0')}</td>
        <td class="py-2 px-2">${formatDateISO(r.friday_date||r.date)}</td>
        <td class="py-2 px-2">${(r.notering==null||r.notering==='') ? '–' : euro(r.notering)}</td>`;
      tbody.appendChild(tr);
    });
  }

  /* PDF export */
  async function makePDFImproved(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    const root = document.getElementById('contentRoot');

    // Header
    doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(17,24,39);
    doc.text(document.getElementById('title').textContent, 40, 40);
    doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(80);
    doc.text(document.getElementById('subtitle').textContent, 40, 58);

    const chartCard=root.querySelector('section > div');
    const tableCard=root.querySelector('aside > div:nth-child(2)');
    const pad=24; let y=80;

    async function addBlock(el){
      const canvas=await html2canvas(el,{ scale:2, backgroundColor:null });
      const img=canvas.toDataURL('imagePNG'); const pageW=doc.internal.pageSize.getWidth();
      const pageH=doc.internal.pageSize.getHeight(); const margin=40;
      let w=canvas.width, h=canvas.height; const maxW=pageW-2*margin;
      if (w>maxW){ const s=maxW/w; w=maxW; h=h*s; }
      const availH=pageH - margin - y;
      if (h>availH && h>0){ const s=availH/h; if (s<1){ w=w*s; h=h*s; } }
      if (y + h > pageH - margin){ doc.addPage(); y=margin; }
      doc.addImage(img,'PNG',margin,y,w,h,undefined,'FAST'); y+=h+pad;
    }

    await addBlock(chartCard);
    await addBlock(tableCard);
    const fname=`belgapom-notering_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(fname);
  }

  async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); const t=await r.text(); if(!t) throw new Error('Lege respons'); if(t.trim().startsWith('<')) throw new Error('HTML i.p.v. JSON'); return JSON.parse(t); }

  (async function init(){
    applyI18N();

    const setLang = (l)=>{ LANG=l; applyI18N(); renderKPI(); renderChart(); renderTable(); if(primeurYears.length){ renderPrimeursTabs(); renderPrimeurs(); } };
    document.getElementById('btn-nl').onclick=()=>setLang('nl');
    document.getElementById('btn-fr').onclick=()=>setLang('fr');
    document.getElementById('btn-en').onclick=()=>setLang('en');

    // Print/PDF
    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('m-print').onclick=()=>window.print();
    document.getElementById('btn-pdf').onclick=makePDFImproved;
    document.getElementById('m-pdf').onclick=makePDFImproved;

    try{
      const data=await fetchJSON(APP_SCRIPT_JSON_URL);
      const rows = Array.isArray(data.rows) ? data.rows : [];
      if(!rows.length) throw new Error('Geen rijen in feed');
      allRows = rows;

      contractKey = ['contract_price','contractprijs','contract'].find(k=>k in allRows[0]) || 'contract_price';

      // Scheiding
      const nonPrimeRows = allRows.filter(r => !r.is_primeur);
      primeurRows = allRows.filter(r => r.is_primeur===true);

      // KPI (laatste vrijdag) gebaseerd op niet-primeurs; fallback = alle rijen
      const baseForLatest = nonPrimeRows.length ? nonPrimeRows : allRows;
      const cutoffIso = (data.meta && data.meta.latest_cutoff_friday_iso) ? data.meta.latest_cutoff_friday_iso : (()=>{ 
        const nowBE=new Date(new Date().toLocaleString('en-US',{timeZone:'Europe/Brussels'}));
        const dow=nowBE.getDay(); const dsf=(dow>=5)?(dow-5):(dow+2); const lf=new Date(nowBE); lf.setDate(nowBE.getDate()-dsf);
        return lf.toISOString().slice(0,10);
      })();
      const cutoffDateObj = new Date(cutoffIso+'T00:00:00'); const target = isoWeekMetaJS(cutoffDateObj);
      latestOverallRow = [...baseForLatest].reverse().find(r=>{
        if(!r.notering && !r[contractKey]) return false;
        const meta=isoWeekMetaJS(new Date((r.friday_date||r.date)+'T00:00:00'));
        return meta.week===target.week && meta.year===target.year;
      }) || baseForLatest[baseForLatest.length-1];

      // Seizoenen alleen uit niet-primeurs; toegestaan: 2024 (24-25) en 2025 (25-26)
      const seasonsRaw = Array.from(new Set(nonPrimeRows.map(r => (r.week_num>=36? r.week_year : r.week_year-1)))).sort((a,b)=>b-a);
      const allowed = [2024, 2025].filter(y => seasonsRaw.includes(y));
      const sel = document.getElementById('seasonSelect'); sel.innerHTML='';
      allowed.forEach(y=>{ const opt=document.createElement('option'); opt.value=y; opt.textContent=`W36 ${y} – W36 ${y+1}`; sel.appendChild(opt); });
      const suggested = data.meta && data.meta.suggested_season_start_year;
      seasonStartYear = allowed.includes(suggested) ? suggested : (allowed[0] || seasonsRaw[0]);
      sel.value = seasonStartYear;

      function updateSeason(){
        const y = parseInt(sel.value,10);
        seasonStartYear = y;
        const startDate = isoWeekStart(y,36), endMon = isoWeekStart(y+1,36);
        const endDate = new Date(endMon); endDate.setDate(endMon.getDate() + 6);
        seasonRows = nonPrimeRows.filter(r=>{
          const d=new Date((r.friday_date||r.date)+'T00:00:00'); 
          return d>=startDate && d<=endDate;
        });
        document.getElementById('seasonLabel').textContent=`W36 ${y} – W36 ${y+1}`;
        renderChart(); renderTable();
      }
      sel.onchange = updateSeason;
      updateSeason();
      renderKPI();

      // PRIMEURS tabs + tabel
      if (primeurRows.length){
        primeurYears = Array.from(new Set(
          primeurRows.map(r => new Date((r.friday_date||r.date)+'T00:00:00').getFullYear())
        )).sort((a,b)=>b-a);
        currentPrimeurYear = primeurYears[0];
        renderPrimeursTabs(); renderPrimeurs();
        document.getElementById('primeursSection').style.display='';
      } else {
        document.getElementById('primeursSection').style.display='none';
      }

      // klaar
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE',{timeZone:'Europe/Brussels'});
      document.getElementById('year').textContent = new Date().getFullYear();
      document.getElementById('chartLoader').classList.add('loading-hidden');
      document.getElementById('tableLoader').classList.add('loading-hidden');
    }catch(err){
      const d=T[LANG]||T.nl;
      document.getElementById('chartLoaderText').textContent = (d.loading_error||'Kon data niet laden: ')+err.message;
      document.getElementById('tableLoaderText').textContent  = (d.loading_error||'Kon data niet laden: ')+err.message;
      document.getElementById('chartLoader').classList.remove('loading-hidden');
      document.getElementById('tableLoader').classList.remove('loading-hidden');
    }
  })();
  </script>
</body>
</html>
